---
title: "SWE Analysis"
author: "AnnaClaire Marley"
date: "03/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
# load the packages
library(tidyverse)
library(janitor)
library(lubridate)
library(gridExtra)
library(grid)
library(dataRetrieval)
library(reshape2)
library(corrplot)
source("Functions/util.R")
source('Functions/graphing.R')
```

```{r, include = FALSE}
# read in csv files - they are already processed as winter months and have a water year column. refer to "Raw_data_cleaning" for code 

car_wint_wy <- read_csv("Carrizo/car_swe_wint_wy_03_19.csv") #Carrizo

ch_wint_wy <- read_csv("Chuska/ch_swe_wint_wy_03_19.csv") # Chuska

bm_wint_wy <- read_csv("Black Mesa/bm_swe_wint_wy_03_19.csv") # Black Mesa

mp_wint_wy <- read_csv("mt_powell/mp_swe_wint_wy_03_19.csv") # Mt Powell

dp_wint_wy <- read_csv("defiance_plateau/dp_swe_wint_wy_03_19.csv") # Defiance Plateau

nm_wint_wy <- read_csv("navajo_mtn/nm_swe_wint_wy_03_19.csv") # Navajo Mountain

```


## Analyses:
- All three regions generally follow the same trends in SWE over time
- 2010 was a high SWE year
- Black Mesa and Carrizo are the most closely correlated


### Annual avereage SWE
```{r, include = FALSE}


# quick function to calculate annual averages
calc_an_region_swe = function(df) {

  av = df %>% 
    group_by(waterYear)  %>% 
    summarize(swe_mm = mean(swe_mm))

return(av)
}

# make the annual average dataframes
car_an_swe <- calc_an_region_swe(car_wint_wy)
ch_an_swe <- calc_an_region_swe(ch_wint_wy)
bm_an_swe <- calc_an_region_swe(bm_wint_wy)
mp_an_swe <- calc_an_region_swe(mp_wint_wy)
dp_an_swe <- calc_an_region_swe(dp_wint_wy)
nm_an_swe <- calc_an_region_swe(nm_wint_wy)


```

```{r, echo = FALSE}

# graph annual average stacked on top of each other
# join together
an_av_all <- join_months(carrizo = car_an_swe, chuska = ch_an_swe, black_mesa = bm_an_swe, mt_powell = mp_an_swe, defiance_plateau = dp_an_swe, navajo_mt = nm_an_swe)

# graph it

an_av_swe_graph <- an_av_all %>% 
  ggplot(aes(x = waterYear, y = swe_mm)) +
  geom_col(aes(fill = region)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(breaks = seq(2004, 2019, by = 2)) +
  scale_fill_discrete(name = "Region", labels = c("Carrizo", "Chuska", "Black Mesa", "Mt. Powell", "Defiance Plateau", "Navajo Mt.")) +
  labs(
    x = "Water Year",
    y = "SWE (mm)"
  ) +
  theme_classic()

an_av_swe_graph

# list of nice colors 
# 

#003f5c
#444e86
#955196
#dd5182
#ff6e54
#ffa600

```

- low swe 2004-2007 and 2018
- Carrizo always has highest average SWE value, while Navajo mountain usually has the least 

## Daily SWE variability (November - April Water Year)
```{r, fig.width=20,fig.height=5, echo= FALSE}
carr_daily <- graph_with_wateryear(car_wint_wy, "Carrizo")
carr_daily
```

```{r, fig.width=20,fig.height=5, echo= FALSE}
ch_daily <- graph_with_wateryear(ch_wint_wy, "Chuska")
ch_daily
```

```{r, fig.width=20,fig.height=5, echo= FALSE}
bm_daily <- graph_with_wateryear(bm_wint_wy, "Black Mesa")
bm_daily
```

```{r, include = FALSE}
## weekly mean variability
carr_weekly <- calc_swe_metrics(car_wint_wy, "1 week", mean)
ch_weekly <- calc_swe_metrics(ch_wint_wy, "1 week", mean)
bm_weekly <- calc_swe_metrics(bm_wint_wy, "1 week", mean)

```


```{r, include=FALSE}
## Annual Mean SWE variability (November - April Water Year)
# create the monthly mean dataframes
carr_annual <- calc_swe_metrics(car_wint_wy, "year", mean)
ch_annual <- calc_swe_metrics(ch_wint_wy, "year", mean)
bm_annual <- calc_swe_metrics(bm_wint_wy, "year", mean)

# insert code below for annual with just water year
```

## Monthly Mean SWE variability (November - April Water Year)
```{r, include=FALSE}
# create the monthly mean dataframes
carr_monthly <- calc_swe_metrics(car_wint_wy, "month", mean)
ch_monthly <- calc_swe_metrics(ch_wint_wy, "month", mean)
bm_monthly <- calc_swe_metrics(bm_wint_wy, "month", mean)
nm_monthly <- calc_swe_metrics(nm_wint_wy, "month", mean)
mp_monthly <- calc_swe_metrics(mp_wint_wy, "month", mean)
dp_monthly <- calc_swe_metrics(dp_wint_wy, "month", mean)
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
# graph it
carr_mn_graph <- graph_with_wateryear(carr_monthly, "Carrizo")
carr_mn_graph
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
ch_mn_graph <- graph_with_wateryear(ch_monthly, "Chuska")
ch_mn_graph
```
```{r,fig.width=20,fig.height=5, echo= FALSE}
bm_mn_graph <- graph_with_wateryear(bm_monthly, "Black Mesa")
bm_mn_graph
```

### Correlation matrix of all monthly mean swe
```{r, echo = FALSE}
# correlation matrix of monthly variability

# first make the dataframe
av_month_swe_all <- carr_monthly %>% 
  rename(carrizo = swe_mm) %>% 
  merge(ch_monthly, by = "date") %>% 
  rename(chuska = swe_mm) %>% 
  merge(bm_monthly, by = "date") %>% 
  rename(black_mesa = swe_mm) %>% 
  select(-waterYear, -waterYear.x, -waterYear.y) %>% 
  merge(nm_monthly, by = "date") %>% 
  rename(navajo_mt = swe_mm) %>% 
  merge(mp_monthly, by = "date") %>% 
  rename(mt_powell = swe_mm) %>% 
  merge(dp_monthly, by = "date") %>% 
  rename(defiance_plateau = swe_mm) %>% 
  select(-waterYear, -waterYear.x, -waterYear.y) %>% 
  remove_rownames() %>% 
  column_to_rownames(var = "date")


```

```{r, echo = FALSE}
# correlation matrix
cor <- cor(av_month_swe_all)
corrplot(cor, method = "ellipse", type = "upper", 
         addCoef.col = "black", tl.col = "black")

```
- Black Mesa to Mt. Powell, Black Mesa to Defiance Plateau and Defiance Plateau and Mt Powell all have the highest correlations between each other 
- Least correlated are Black Mesa and Navajo Mt, Navajo Mt and Mt Powell, Navajo Mt and Defiance Plateau

# Monthly Median

```{r, include=FALSE}
# create the monthly mean dataframes
carr_mnth_med <- calc_swe_metrics(car_wint_wy, "month", median)
ch_mnth_med <- calc_swe_metrics(ch_wint_wy, "month", median)
bm_mnth_med <- calc_swe_metrics(bm_wint_wy, "month", median)
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
# graph it
carr_med_graph <- graph_with_wateryear(carr_mnth_med, "Carrizo")
carr_med_graph
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
ch_med_graph <- graph_with_wateryear(ch_mnth_med, "Chuska")
ch_med_graph
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
bm_med_graph <- graph_with_wateryear(bm_mnth_med, "Black Mesa")
bm_med_graph
```


## Monthly Anomalies (November - April Water Year)

```{r,include = FALSE}
# create anomaly dataframes
car_anom <- calc_month_anom(carr_monthly)
ch_anom <- calc_month_anom(ch_monthly)
bm_anom <- calc_month_anom(bm_monthly)
nm_anom <- calc_month_anom(nm_monthly)
mp_anom <- calc_month_anom(mp_monthly)
dp_anom <- calc_month_anom(dp_monthly)

```

```{r,fig.width=20,fig.height=5, echo= FALSE}
#graph it
car_anom_graph <- plot_anomaly(car_anom, title = "Carrizo")
car_anom_graph
```

```{r,fig.width=20,fig.height=5, echo= FALSE}
ch_anom_graph <- plot_anomaly(ch_anom, title = "Chuska")
ch_anom_graph

```

```{r,fig.width=20,fig.height=5, echo= FALSE}
bm_anom_graph <- plot_anomaly(bm_anom, title = "Black Mesa")
bm_anom_graph

```


```{r,fig.width=20,fig.height=5, echo= FALSE}
nm_anom_graph <- plot_anomaly(nm_anom, title = "Navajo Mountain")
nm_anom_graph

```


## Correlations Between locations

### Weekly mean correlation November - April 

```{r, include = FALSE}
# pearson's correlation
corr_chu_bm <- cor.test(bm_weekly$swe_mm, ch_weekly$swe_mm)$estimate
chu_bm_r2 <- (corr_chu_bm)^2

corr_chu_carr <- cor.test(carr_weekly$swe_mm, ch_weekly$swe_mm)$estimate
chu_carr_r2 <- (corr_chu_carr)^2

corr_carr_bm <- cor.test(bm_weekly$swe_mm, carr_weekly$swe_mm)$estimate
carr_bm_r2 <- (corr_carr_bm)^2


```


Pearson's Correlation R squared:

- Chuska vs Black Mesa: `r round(chu_bm_r2, 2)`

- Carrizo vs Chuska: `r round(chu_carr_r2, 2)`

- Carrizo vs Black Mesa: `r round(carr_bm_r2, 2)`


```{r, include = FALSE}

# linear models
corr_chu_bm_lm <- lm(bm_weekly$swe_mm ~ ch_weekly$swe_mm)
  chu_bm_r2 <- summary(corr_chu_bm_lm)$r.squared

corr_chu_carr_lm <- lm(carr_weekly$swe_mm ~ ch_weekly$swe_mm)
  chu_carr_r2 <- summary(corr_chu_carr_lm)$r.squared 

corr_carr_bm_lm <- lm(bm_weekly$swe_mm ~ carr_weekly$swe_mm)
  carr_bm_r2 <- summary(corr_carr_bm_lm)$r.squared 

```


```{r, echo = FALSE}
# graph it
plot(ch_weekly$swe_mm, bm_weekly$swe_mm)
abline(corr_chu_bm_lm)

```

Chuska vs Black Mesa R squared: `r chu_bm_r2`

```{r, echo = FALSE}
plot(ch_weekly$swe_mm, carr_weekly$swe_mm)
abline(corr_chu_carr_lm)
```

Chuska vs Carrizo R squared: `r chu_carr_r2`

```{r, echo = FALSE}
plot(carr_weekly$swe_mm, bm_weekly$swe_mm)
abline(corr_carr_bm_lm)

```

Black Mesa vs Carrizo R squared: `r carr_bm_r2`


## Month specific time series

# November

```{r, include = FALSE, echo = FALSE}
# filter just for November
car_nov <- month_ts(carr_monthly, 11)
ch_nov <- month_ts(ch_monthly, 11)
bm_nov <- month_ts(bm_monthly, 11)
nm_nov <- month_ts(nm_monthly, 11)
dp_nov <- month_ts(dp_monthly, 11) 
mp_nov <- month_ts(mp_monthly, 11)

nov_swe <- join_months(carrizo = car_nov, chuska = ch_nov, black_mesa = bm_nov, defiance_plateau = dp_nov, mt_powell = mp_nov, navajo_mt = nm_nov)

```

```{r, echo = FALSE}
# plot it BE CAREFUL WITH THESE, NOT ENTIRELY SURE WHAT THIS SHOWS

# plot_months(nov_swe, month = "November")

```

```{r, echo = FALSE}
# plot box plot for each month

nov_swe_plot <- nov_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "November"
  ) +
  theme_classic() 



```


# December 

```{r, include = FALSE}

car_dec <- month_ts(carr_monthly, 12)
ch_dec <- month_ts(ch_monthly, 12)
bm_dec <- month_ts(bm_monthly, 12)
nm_dec <- month_ts(nm_monthly, 12)
dp_dec <- month_ts(dp_monthly, 12) 
mp_dec <- month_ts(mp_monthly, 12)

dec_swe <- join_months(carrizo = car_dec, chuska = ch_dec, black_mesa = bm_dec, defiance_plateau = dp_dec, mt_powell = mp_dec, navajo_mt = nm_dec)

```

```{r, echo = FALSE}

# plot_months(dec_swe, month = "December")

```


```{r, echo = FALSE}
# plot box plot for each month

dec_swe_plot <- dec_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "December"
  ) +
  theme_classic() 



```



# January

```{r, include = FALSE}

car_jan <- month_ts(carr_monthly, 1)
ch_jan <- month_ts(ch_monthly, 1)
bm_jan <- month_ts(bm_monthly, 1)
nm_jan <- month_ts(nm_monthly, 1)
dp_jan <- month_ts(dp_monthly, 1) 
mp_jan <- month_ts(mp_monthly, 1)

jan_swe <- join_months(carrizo = car_jan, chuska = ch_jan, black_mesa = bm_jan, defiance_plateau = dp_jan, mt_powell = mp_jan, navajo_mt = nm_jan)

```

```{r, echo = FALSE}

# plot_months(jan_swe, month = "January")

```


```{r, echo = FALSE}
# plot box plot for each month

jan_swe_plot <- jan_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "January"
  ) +
  theme_classic() 



```





# February
```{r, include = FALSE}

car_feb <- month_ts(carr_monthly, 2)
ch_feb <- month_ts(ch_monthly, 2)
bm_feb <- month_ts(bm_monthly, 2)
nm_feb <- month_ts(nm_monthly, 2)
dp_feb <- month_ts(dp_monthly, 2) 
mp_feb <- month_ts(mp_monthly, 2)

feb_swe <- join_months(carrizo = car_feb, chuska = ch_feb, black_mesa = bm_feb, defiance_plateau = dp_feb, mt_powell = mp_feb, navajo_mt = nm_feb)

```

```{r, echo = FALSE}

# plot_months(feb_swe, month = "February")

```


```{r, echo = FALSE}
# plot box plot for each month

feb_swe_plot <- feb_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "February"
  ) +
  theme_classic() 



```





# March
```{r, include = FALSE}

car_mar <- month_ts(carr_monthly, 3)
ch_mar <- month_ts(ch_monthly, 3)
bm_mar <- month_ts(bm_monthly, 3)
nm_mar <- month_ts(nm_monthly, 3)
dp_mar <- month_ts(dp_monthly, 3) 
mp_mar <- month_ts(mp_monthly, 3)

mar_swe <- join_months(carrizo = car_mar, chuska = ch_mar, black_mesa = bm_mar, defiance_plateau = dp_mar, mt_powell = mp_mar, navajo_mt = nm_mar)

```

```{r, echo = FALSE}

# plot_months(mar_swe, month = "March")

```


```{r, echo = FALSE}
# plot box plot for each month

mar_swe_plot <- mar_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "March"
  ) +
  theme_classic() 



```




# April

```{r, include = FALSE}

car_apr <- month_ts(carr_monthly, 4)
ch_apr <- month_ts(ch_monthly, 4)
bm_apr <- month_ts(bm_monthly, 4)
nm_apr <- month_ts(nm_monthly, 4)
dp_apr <- month_ts(dp_monthly, 4) 
mp_apr <- month_ts(mp_monthly, 4)

apr_swe <- join_months(carrizo = car_apr, chuska = ch_apr, black_mesa = bm_apr, defiance_plateau = dp_apr, mt_powell = mp_apr, navajo_mt = nm_apr)


```

```{r, echo = FALSE}

# plot_months(apr_swe, month = "April")

```


```{r, echo = FALSE}
# plot box plot for each month

apr_swe_plot <- apr_swe %>% 
  ggplot(aes(region, swe_mm))+
  geom_boxplot(aes(fill = region), show.legend = FALSE) +
  labs(
    x = "Region",
    y = "SWE (mm)",
    title = "April"
  ) +
  theme_classic() 



```

### November - April Averaged SWE values

```{r, echo = FALSE, fig.width=20, fig.height=5}

grid.arrange(nov_swe_plot, dec_swe_plot, jan_swe_plot, feb_swe_plot, mar_swe_plot, apr_swe_plot, ncol = 3)

```

- Chuska and Defiance plateau frequently have the higest av swe values, navajo mt usually has the least. 
- most everything is melted by april

### SWE compared to Suzanne's SCA

```{r, echo = FALSE, warning=FALSE, echo = FALSE}

# read in SG
ch_sca_month <- read_csv("Chuska/ch_sca_sg.csv") %>% 
  clean_names() %>% 
  mutate(date = as.Date(paste(cal_year, r_month, "01", sep="-"))) %>% 
  select(date, water_year, mean_sca_km2, anomaly_by_month)

# plot SCA
sca_plot <- ch_sca_month %>% 
  ggplot(aes(x = date, y = mean_sca_km2)) +
  geom_line() +
  scale_x_date(date_labels = "%b%Y")+
  scale_y_continuous(expand = c(0,0)) +
  theme_classic()

# plot anomalies
sca_anom <- ch_sca_month %>% 
  ggplot(aes(x = date, y = anomaly_by_month)) +
  geom_line() +
  scale_x_date(date_labels = "%b%Y")+
  scale_y_continuous(expand = c(0,0)) +
  labs(
    y = "SCA Anomaly"
  ) +
  theme_classic()

```

**SCA Anomaly was scaled down by a factor of 10 to improve analysis**


```{r, echo = FALSE}
# now try and make Suzanne Chuska SCA anomaly overlay my Chuska anomaly
# make a combined swe and sca anomaly dataframe
chuska_swe_sca <- ch_anom %>% 
  select(-month) %>% 
  arrange(date) %>% 
  merge(ch_sca_month, by = "date") %>% 
  rename(swe_anom = anomaly,
         sca_anom = anomaly_by_month)
  
# now plot them together:
plot <- chuska_swe_sca %>% 
    ggplot(aes(x = date)) +
    geom_col(aes(y = swe_anom, fill = sign), show.legend = FALSE) +
    #scale_y_continuous(limits = c(-20, 100)) +
    scale_fill_manual(values = c("negative" = "red", "positive" = "dark green")) +
    geom_line(aes(y = sca_anom/10)) +
    scale_x_date(date_labels = "%b%Y") +
    scale_y_continuous(sec.axis = sec_axis(~.*5, name = "SCA Anomaly (km2)")) +
    labs(
      x = "Calendar Date",
      y = "SWE Anomaly (mm)",
      title = "Chuska SWE vs SCA Anomaly"
    ) +
    theme_classic()
plot

```

- SCA anomalies only somewhat track to SWE anomalies 
