---
title: "SWE & Snow Depth"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include = FALSE}
# load the packages
library(tidyverse)
library(janitor)
library(lubridate)
library(gridExtra)
library(grid)
library(dataRetrieval)
library(reshape2)
source("Functions/util.R")
source('Functions/graphing.R')
```

# {.tabset}

This rmarkdown shows some of the relationships between SWE and snow depth at each location. Analyses conducted include:

- Correlation between SWE and Snow Depth with the colors grouped by months
- linear relationship between Swe and snow depth for each month
- graph of the slopes of the monthly linear relationship

# {.tabset}

### Correlation between SWE and Snow Depth (November - April Water Year)

- SWE and snow depth are highly correlated across regions (>0.9)
- Generally, as snow depth and swe values get larger, they become less closely correlated



```{r, include = FALSE}
# read in the daily data files
car_swe <- read_csv("winter_wy/car_swe_wy_03_19.csv")
car_dpth <- read_csv("winter_wy/car_dpth_wy_03_19.csv")

# combine to make a dataframe of swe and dpth daily data
car_swe_dpth <- merge_snow(car_swe, car_dpth)

# monthly means correlation
car_swe_av <- calc_swe_metrics(car_swe, "month", mean)
car_dpth_av <- calc_depth_metrics(car_dpth, "month", mean)

```



### Carrizo 

- Generally, January, February, and March swe and depth values are less correlated than other months


```{r, include = FALSE}
# average swe - depth metric (from swe/depth)
car_av_ratio <- car_swe_dpth %>% 
  filter(snow_ratio != "NaN") %>% 
  filter(snow_ratio != "Inf") %>% 
  group_by(month) %>% 
  summarize(
    mean_ratio = mean(snow_ratio)
  )
  

car_av_snow_ratio <- mean(car_av_ratio$mean_ratio)
  

```


```{r, echo=FALSE}
# daily data linear regression:

car_swe_dpth_lm <- lm(car_swe_dpth$swe_mm ~ car_swe_dpth$depth_mm)
car_swedpth_r2 <- summary(car_swe_dpth_lm)$adj.r.squared

```

```{r, echo = FALSE}
# graph it 

car_daily_cor_swe_dpth <- plot_cor(car_swe_dpth, car_swedpth_r2, region = "Carrizo")
 car_daily_cor_swe_dpth

```

Each month has it's own line:

```{r,echo= FALSE}

plot_cor_month(car_swe_dpth, car_swedpth_r2, region = "Carrizo")



```


Slope of the line of the linear relationship of each month's swe and snow depth
- almost linearly increasing slop through the water year until April, where the slope decreases back down to almost the February slope


```{r, echo = FALSE}
# equations of the lines:

car_mnth_equ <- cor_equation(car_swe_dpth)
plot_slope_swedpth(car_mnth_equ, title = "Carrizo")

```

# {.tabset}

### Chuska 

- Generally, January, February, March, amd some April swe and depth values are less correlated than other months

```{r, include=FALSE}
# read in the files
ch_swe <- read_csv("winter_wy/ch_swe_wy_03_19.csv")
ch_dpth <- read_csv("winter_wy/ch_dpth_wy_03_19.csv")

# merge them together 
ch_swe_dpth <- merge_snow(ch_swe, ch_dpth)

```


```{r, include = FALSE}
# average swe - depth metric (from swe/depth)
ch_av_ratio <- ch_swe_dpth %>% 
  filter(snow_ratio != "NaN") %>% 
  filter(snow_ratio != "Inf") %>% 
  group_by(month) %>% 
  summarize(
    mean_ratio = mean(snow_ratio)
  )
  

ch_av_snow_ratio <- mean(ch_av_ratio$mean_ratio)
  


```


```{r, echo = FALSE}
# linear regression
ch_swe_v_depth_lm <- lm(ch_swe_dpth$swe_mm ~ ch_swe_dpth$depth_mm)
ch_swedepth_r2 <- summary(ch_swe_v_depth_lm)$adj.r.squared 


# plot it
ch_swe_v_depth_graph <- plot_cor(ch_swe_dpth, ch_swedepth_r2, region = "Chuska")
ch_swe_v_depth_graph 
```



Each month has it's own line:

```{r, echo = FALSE}

plot_cor_month(ch_swe_dpth, car_swedpth_r2, region = "Chuska")



```

- almost perfect linear increase in the slope of the relationship between swe and depth through time

```{r, echo = FALSE}
# equations of the lines:

ch_mnth_equ <- cor_equation(ch_swe_dpth)  

plot_slope_swedpth(ch_mnth_equ, title = "Chuska")


```

# {.tabset}

### Black Mesa 

- Generally, January, February, and March swe and depth values are less correlated than other months

```{r, include=FALSE}
# read in the files
bm_swe <- read_csv("winter_wy/bm_swe_wy_03_19.csv")
bm_dpth <- read_csv("winter_wy/bm_dpth_wy_03_19.csv")

# merge them together 
bm_swe_dpth <- merge_snow(bm_swe, bm_dpth)

```


```{r, include = FALSE}
# average swe - depth metric (from swe/depth)
bm_av_ratio <- bm_swe_dpth %>% 
  filter(snow_ratio != "NaN") %>% 
  filter(snow_ratio != "Inf") %>% 
  group_by(month) %>% 
  summarize(
    mean_ratio = mean(snow_ratio)
  )
  

bm_av_snow_ratio <- mean(bm_av_ratio$mean_ratio)
  


```


```{r, echo = FALSE}
# linear regression
bm_swe_v_depth_lm <- lm(bm_swe_dpth$swe_mm ~ bm_swe_dpth$depth_mm)
bm_swedepth_r2 <- summary(bm_swe_v_depth_lm)$adj.r.squared 


# plot it
bm_swe_v_depth_graph <- plot_cor(bm_swe_dpth, bm_swedepth_r2, region = "Black Mesa")
bm_swe_v_depth_graph
```


Each month has it's own line:

```{r, echo = FALSE}

plot_cor_month(bm_swe_dpth, car_swedpth_r2, region = "Black Mesa")

```

- almost linearly increasing slop through the water year until April, where the slope decreases back down to almost the November slope

```{r, echo = FALSE}
# equations of the lines:

bm_mnth_equ <- cor_equation(bm_swe_dpth)
plot_slope_swedpth(bm_mnth_equ, title = "Black Mesa")
```

# {.tabset}

### Navajo Mt 

- March, January, and some december most often less correlated
```{r, include=FALSE}
# read in the files
nm_swe <- read_csv("winter_wy/nm_swe_wy_03_19.csv")
nm_dpth <- read_csv("winter_wy/nm_dpth_wy_03_19.csv")

# merge them together 
nm_swe_dpth <- merge_snow(nm_swe, nm_dpth)

```


```{r, echo = FALSE}
# linear regression
nm_swe_v_depth_lm <- lm(nm_swe_dpth$swe_mm ~ nm_swe_dpth$depth_mm)
nm_swedepth_r2 <- summary(nm_swe_v_depth_lm)$adj.r.squared 


# plot it
nm_swe_v_depth_graph <- plot_cor(nm_swe_dpth, nm_swedepth_r2, region = "Navajo Mt")
nm_swe_v_depth_graph
```


Each month has it's own line:

```{r, echo = FALSE}

plot_cor_month(nm_swe_dpth, car_swedpth_r2, region = "Navajo Mountain")


```

- Seems to be the only location where there is not really a clear linear increase in the slope of the relationship between swe and snow depth

```{r, echo = FALSE}

# equations of the lines:

nm_mnth_equ <- cor_equation(nm_swe_dpth)
plot_slope_swedpth(nm_mnth_equ, title = "Navajo Mt")

```

# {.tabset}

### Mt Powell 

- Jn, Feb and March seem to be outliers

```{r, include=FALSE}
# read in the files
mp_swe <- read_csv("winter_wy/mp_swe_wy_03_19.csv")
mp_dpth <- read_csv("winter_wy/mp_dpth_wy_03_19.csv")

# merge them together 
mp_swe_dpth <- merge_snow(mp_swe, mp_dpth)

```



```{r, echo = FALSE}
# linear regression
mp_swe_v_depth_lm <- lm(mp_swe_dpth$swe_mm ~ mp_swe_dpth$depth_mm)
mp_swedepth_r2 <- summary(mp_swe_v_depth_lm)$adj.r.squared 


# plot it
mp_swe_v_depth_graph <- plot_cor(mp_swe_dpth, mp_swedepth_r2, region = "Mt Powell")
mp_swe_v_depth_graph
```


Each month has it's own line:

```{r, echo = FALSE}

plot_cor_month(mp_swe_dpth, car_swedpth_r2, region = "Mt Powell")



```

- almost linearly increasing slop through the water year until April, where the slope decreases back down to almost the November slope

```{r, echo = FALSE}

# equations of the lines:

mp_mnth_equ <- cor_equation(mp_swe_dpth)
plot_slope_swedpth(mp_mnth_equ, title = "Mt Powell")

```

# {.tabset}

### Defiance Plateau 

- March seems to be least correlated

```{r, include=FALSE}
# read in the files
dp_swe <- read_csv("winter_wy/dp_swe_wy_03_19.csv")
dp_dpth <- read_csv("winter_wy/dp_dpth_wy_03_19.csv")

# merge them together 
dp_swe_dpth <- merge_snow(dp_swe, dp_dpth)

```



```{r, echo = FALSE}
# linear regression
dp_swe_v_depth_lm <- lm(dp_swe_dpth$swe_mm ~ dp_swe_dpth$depth_mm)
dp_swedepth_r2 <- summary(dp_swe_v_depth_lm)$adj.r.squared 


# plot it
dp_swe_v_depth_graph <- plot_cor(dp_swe_dpth, dp_swedepth_r2, region = "Defiance Plateau")
dp_swe_v_depth_graph
```


Each month has it's own line:

```{r, echo = FALSE}

plot_cor_month(dp_swe_dpth, car_swedpth_r2, region = "Defiance Plateau")




```

- almost linearly increasing slop through the water year until April, where the slope decreases back down to almost the January slope

```{r, echo = FALSE}

# equations of the lines:

dp_mnth_equ <- cor_equation(dp_swe_dpth)
plot_slope_swedpth(dp_mnth_equ, title = "Defiance Plateau")

```

# {.tabset}

## SWE-depth ratio 

- annual averaged metric 

- **Carrizo**: `r round(car_av_snow_ratio, 3)`

- **Chuska**: `r round(ch_av_snow_ratio, 3)`

- **Black Mesa**: `r round(bm_av_snow_ratio, 3)`
.
### SWE-depth ratio monthly average: 

- Generally, the ratio increases through the water year (starting at november). This corroborates the trend seen in the correlation graph where depth and swe becomes less correlated as the water year progresses

```{r, echo = FALSE}

all_swe_dpth <- merge(bm_av_ratio, ch_av_ratio, by = "month") %>% 
  merge(car_av_ratio, by = "month") %>% 
  rename(black_mesa = mean_ratio.x, chuska = mean_ratio.y, carrizo = mean_ratio) %>% 
  mutate(black_mesa = round(black_mesa, 3))  %>% 
  mutate(carrizo = round(carrizo, 3))  %>% 
  mutate(chuska = round(chuska, 3)) 
all_swe_dpth

  

```



### SWE and Snow depth (November - April Water Year) 

- Generally, snow depth is much greater than SWE, but follows the same general patter

```{r, fig.width=20,fig.height=5, echo = FALSE, warning=FALSE, message=FALSE}
# carrizo 
graph_with_wateryear(car_swe_dpth, title = "Carrizo") +
  geom_line(aes(y = depth_mm), color = "blue") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Snow Depth (mm)")) +
  theme(axis.line.y.right = element_line(color = "blue"),
        axis.text.y.right = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "blue"))
  

```


```{r, fig.width=20,fig.height=5, echo = FALSE, warning=FALSE, message=FALSE}
# carrizo 
graph_with_wateryear(ch_swe_dpth, title = "Chuska") +
  geom_line(aes(y = depth_mm), color = "blue") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Snow Depth (mm)")) +
  theme(axis.line.y.right = element_line(color = "blue"),
        axis.text.y.right = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "blue"))
  

```

```{r, fig.width=20,fig.height=5,echo = FALSE, warning=FALSE, message=FALSE}
# carrizo 
graph_with_wateryear(bm_swe_dpth, title = "Black Mesa") +
  geom_line(aes(y = depth_mm), color = "blue") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Snow Depth (mm)")) +
  theme(axis.line.y.right = element_line(color = "blue"),
        axis.text.y.right = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "blue")) 
  

```

### Depth scaled (depth*0.2) by swe/depth metric

- shows how well correlated SWE and snow depth are

```{r, fig.width=20,fig.height=5, echo = FALSE, message = FALSE}

graph_with_wateryear(bm_swe_dpth, title = "Black Mesa", type = geom_col) +
  geom_line(aes(y = depth_mm*0.2), color = "blue") +
  scale_y_continuous(sec.axis = sec_axis(~.*5, name = "Snow Depth (mm)"), expand = c(0,0)) +
  theme(axis.line.y.right = element_line(color = "blue"),
        axis.text.y.right = element_text(color = "blue"),
        axis.title.y.right = element_text(color = "blue")) 
  

```



