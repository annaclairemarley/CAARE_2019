---
title: "Standardized Precipitation Index"
author: "AnnaClaire Marley"
date: "7/30/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
# load the packages
library(tidyverse)
library(janitor)
library(lubridate)
library(gridExtra)
library(grid)
library(dataRetrieval)
library(reshape2)
library(corrplot)
library(precintcon)
source("Functions/util.R")
source('Functions/graphing.R')
```

This Rmarkdown shows analysis of SPI at the watersheds bordering the Chuskas and Tsaile chaper

```{r, echo = FALSE, message=FALSE}
# first load in chuska winter anomalies

ch_wint_anom <- read_csv("Chuska/ch_wint_swe_anom.csv") %>% 
  select(waterYear, anomaly_perc)

# for later use:
all_months = c(1,2,3,4,5,6,7,8,9,10,11,12)

```

# Watersheds

## Chaco

### Chaco SPI

```{r, echo = FALSE, message=FALSE}
# read in chaco precipitation

chaco_precip <- read_csv("watersheds/chaco_precip.csv") 

# now change the precip data to spi
chaco_spi <- precip_to_spi(chaco_precip)

# Chaco SPI June

chaco_spi_june <- chaco_spi %>% 
  filter(year(date) >= 2004) %>% 
  filter(month(date) == 6) %>% 
  add_water_year() %>% 
  select(waterYear, spi)

chaco_spi_july <-chaco_spi %>% 
  filter(year(date) >= 2004) %>% 
  filter(month(date) == 7) %>% 
  add_water_year() %>% 
  select(waterYear, spi)

```

```{r, echo = FALSE}

# whole year 6 month SPI
plot_spi(chaco_spi, month = all_months, title = "Chaco SPI") 

  chaco_spi_graph <- chaco_spi %>% 
      filter(month(date) %in% all_months) %>% 
      ggplot(aes(x = date, y = spi)) +
      geom_col(aes(fill = sign), show.legend = FALSE) +
      scale_fill_manual(values = c("negative" = "#df5e3d", "positive" = "#a6c39d")) +
      labs(
        y = "SPI",
        x = "Water Year"
      ) +
      scale_y_continuous(expand = c(0,0)) +
    geom_smooth(method = "lm") +
      theme_classic()
  
  chaco_spi_graph

# let's take a look at the 6 month June SPI of each year
plot_spi(chaco_spi, month = c(6), title = "Chaco June SPI")

```

### Chaco PDSI and SPI

```{r, echo = FALSE}
# read in the PDSI January-June 6 month average 
chaco_pdsi_jun_6 <- read_csv("watersheds/chaco_pdsi_jun_6.csv")

# merge with spi
chaco_spi_pdsi <- chaco_spi_june %>% 
  merge(chaco_pdsi_jun_6, by = "waterYear")

# find and plot the correlation between the two
plot_cor_pdsi_spi(chaco_spi_pdsi, title = "Chaco Jan-June 6 month")

```


### Chaco SPI and Chuska SWE

```{r, echo = FALSE}
### now let's look at Chuska monthly swe anomaly and June 6 month SPI ###
plot_swe_spi(chaco_spi, month = c(5), region_time = "Chaco May 6 month")
plot_swe_spi(chaco_spi, month = c(6), region_time = "Chaco June 6 month")
plot_swe_spi(chaco_spi, month = c(7), region_time = "Chaco July 6 month")
```

```{r, echo = FALSE}

# let's look at the correlation between them 
ch_chaco_spi_june <- merge_ch_spi(chaco_spi, months = c(6)) 
ch_chaco_spi_june_plot <- plot_cor_swe_spi(ch_chaco_spi_june,
                                           title = "Chuska Winter SWE Anomaly and Chaco June SPI")


ch_chaco_correct <- swe_spi_same(ch_chaco_spi_june, type = "total")
ch_chaco_positive <- swe_spi_same(ch_chaco_spi_june, type = "positive")
ch_chaco_negative <- swe_spi_same(ch_chaco_spi_june, type = "negative")

```

- The percent of times swe the anomaly for the year and spi had the same sign `r ch_chaco_correct*100`%

- The percent of times swe anomaly for the year was positive and was followed by a positive spi had the same sign out of all positive swe years `r ch_chaco_positive*100`%

- The percent of times swe anomaly for the year was negative and was followed by a negative spi had the same sign out of all negative swe years `r ch_chaco_negative*100`%

```{r, echo = FALSE}
# let's try for july spi

ch_chaco_spi_july <- merge_ch_spi(chaco_spi, months = c(7)) 

ch_chaco_spi_july_plot <- plot_cor_swe_spi(ch_chaco_spi_july, 
                                           title = "Chuska Winter SWE Anomaly and Chaco July SPI")


```

- January -- June SPI seems to be much more correlated to winter SWE than does Feb -- July SPI

```{r, echo = FALSE}
# let's try for May spi

ch_chaco_spi_may <- merge_ch_spi(chaco_spi, months = c(5))
ch_chaco_spi_may_plot <- plot_cor_swe_spi(ch_chaco_spi_may, title = "Chuska Winter SWE Anomaly and Chaco May SPI")


```

```{r, echo = FALSE}

# let's look at the correlation between them  for MAY
ch_chaco_correct_may <- swe_spi_same(ch_chaco_spi_may, type = "total")
ch_chaco_positive_may <- swe_spi_same(ch_chaco_spi_may, type = "positive")
ch_chaco_negative_may <- swe_spi_same(ch_chaco_spi_may, type = "negative")

```

- The percent of times swe the anomaly for the year and spi had the same sign `r ch_chaco_correct_may*100`%

- The percent of times swe anomaly for the year was positive and was followed by a positive spi had the same sign out of all positive swe years `r ch_chaco_positive_may*100`%

- The percent of times swe anomaly for the year was negative and was followed by a negative spi had the same sign out of all negative swe years `r ch_chaco_negative_may*100`%


```{r, echo = FALSE}
# let's try for April spi

ch_chaco_spi_apr <- merge_ch_spi(chaco_spi, months = c(4)) 
  
ch_chaco_spi_apr_plot <- plot_cor_swe_spi(ch_chaco_spi_apr,
                                          title = "Chuska Winter SWE Anomaly and Chaco April SPI")

```

```{r, echo=FALSE, fig.width=7}

grid.arrange(ch_chaco_spi_apr_plot, ch_chaco_spi_may_plot, 
             ch_chaco_spi_june_plot, ch_chaco_spi_july_plot, ncol = 2)

```


## Chinle

### Chinle SPI

```{r, echo = FALSE, message=FALSE}
# read in precipitation
chinle_precip <- read_csv("watersheds/chinle_precip.csv") 

# now change the precip data to spi
chinle_spi <- precip_to_spi(chinle_precip)

# SPI June

```

```{r, echo = FALSE}

# whole year 6 month SPI
plot_spi(chinle_spi, month = all_months, title = "Chinle SPI")

# let's take a look at the 6 month June SPI of each year
plot_spi(chinle_spi, month = c(6), title = "Chinle June SPI")

```

### Chinle SPI vs PDSI

```{r, echo = FALSE, error = TRUE}
# read in the PDSI January-June 6 month average 
chinle_pdsi_jun_6 <- read_csv("watersheds/chinle_pdsi_jun_6.csv")

# merge with spi
chinle_spi_pdsi <- chinle_pdsi_jun_6 %>% 
  merge(chinle_pdsi_jun_6, by = "waterYear")

# find and plot the correlation between the two
plot_cor_pdsi_spi(chinle_spi_pdsi, title = "Chinle June 6 month")



```


### Chinle SPI and Chuska SWE

```{r, echo = FALSE}
### now let's look at Chuska monthly swe anomaly and June 6 month SPI ###
plot_swe_spi(chinle_spi, month = c(6), region_time = "Chinle June 6 month")

```

```{r, echo = FALSE}
# let's look at the correlation between them 
ch_chinle_spi_june <- merge_ch_spi(chinle_spi, months = c(6))
ch_chinle_spi_june_plot <- plot_cor_swe_spi(ch_chinle_spi_june, 
                                            title = "Chuska Winter SWE Anomaly and Chinle June SPI")

ch_chinle_correct <- swe_spi_same(ch_chinle_spi_june, type = "total")
ch_chinle_positive <- swe_spi_same(ch_chinle_spi_june, type = "positive")
ch_chinle_negative <- swe_spi_same(ch_chinle_spi_june, type = "negative")

```

- The percent of times swe the anomaly for the year and spi had the same sign `r ch_chinle_correct*100`%

- The percent of times swe anomaly for the year was positive and was followed by a positive spi had the same sign out of all positive swe years `r ch_chinle_positive*100`%

- The percent of times swe anomaly for the year was negative and was followed by a negative spi had the same sign out of all negative swe years `r ch_chinle_negative*100`%

```{r, echo=FALSE}
# try July SPI
ch_chinle_spi_july <- merge_ch_spi(chinle_spi, months = c(7)) 
ch_chinle_spi_july_plot <- plot_cor_swe_spi(ch_chinle_spi_july, 
                                      title = "Chuska Winter SWE Anomaly and Chinle July SPI")


```

- Chuska SWE is also much less corelated to Chinle July 6 month SPI than it is to June 6 month

```{r, echo=FALSE}
# try May SPI
ch_chinle_spi_may <- merge_ch_spi(chinle_spi, months = c(5)) 
ch_chinle_spi_may_plot <- plot_cor_swe_spi(ch_chinle_spi_may, 
                                           title = "Chuska Winter SWE Anomaly and Chinle May SPI")

```

```{r, fig.width=7}

grid.arrange(ch_chinle_spi_may_plot, ch_chinle_spi_june_plot, ch_chinle_spi_july_plot, ncol = 2)
```



## Middle San Juan

```{r, echo = FALSE, message=FALSE}
# read in precipitation
mid_sj_precip <- read_csv("watersheds/mid_sj_precip.csv") 

# now change the precip data to spi
mid_sj_spi <- precip_to_spi(mid_sj_precip)

# SPI June
mid_sj_spi_june <- mid_sj_spi %>% 
  filter(year(date) >= 2004) %>% 
  filter(month(date) == 6) %>% 
  add_water_year() %>% 
  select(waterYear, spi)

```

```{r, echo = FALSE}
# whole year 6 month SPI
plot_spi(mid_sj_spi, month = all_months, title = "Chinle SPI")

# let's take a look at the 6 month June SPI of each year
plot_spi(mid_sj_spi, month = c(6), title = "Chinle June SPI")

```

### Middle San Juan SPI and PDSI

```{r, echo = FALSE}
# read in the PDSI January-June 6 month average 
mid_sj_pdsi_jun_6 <- read_csv("watersheds/mid_sj_pdsi_jun_6.csv")

# merge with spi
mid_sj_spi_pdsi <- mid_sj_spi_june %>% 
  merge(mid_sj_pdsi_jun_6, by = "waterYear")

# find and plot the correlation between the two
mid_sj_spi_pdsi_plot <- plot_cor_pdsi_spi(mid_sj_spi_pdsi, 
                                          title = "Middle San Juan June 6 month")



```

### Middle San Juan SPI and Chuska SWE

```{r, echo = FALSE}
### now let's look at Chuska monthly swe anomaly and June 6 month SPI ###
plot_swe_spi(mid_sj_spi, month = c(6), region_time = "Middle San Juan June 6 month")

```

```{r, echo = FALSE}
# let's look at the correlation between them 
ch_mid_sj_spi_june <- merge_ch_spi(mid_sj_spi, months = c(6))

ch_mid_sj_spi_june_plot <- plot_cor_swe_spi(ch_mid_sj_spi_june, 
                 title = "Chuska Winter SWE Anomaly and Middle San Juan June SPI")

ch_mid_sj_correct <- swe_spi_same(ch_mid_sj_spi_june, type = "total")
ch_mid_sj_positive <- swe_spi_same(ch_mid_sj_spi_june, type = "positive")
ch_mid_sj_negative <- swe_spi_same(ch_mid_sj_spi_june, type = "negative")

```

- The percent of times swe the anomaly for the year and spi had the same sign `r ch_mid_sj_correct*100`%

- The percent of times swe anomaly for the year was positive and was followed by a positive spi had the same sign out of all positive swe years `r ch_mid_sj_positive*100`%

- The percent of times swe anomaly for the year was negative and was followed by a negative spi had the same sign out of all negative swe years `r ch_mid_sj_negative*100`%



## Upper  Puerco


----------------

## Tsaile Chapter

### Tsaile SPI

#### 6 month SPI
```{r, include = FALSE}
# read in TSAILE precipitation

tsaile_precip <- read_csv("Chapters/tsaile_precip.csv")

# now change the precip data to spi
tsaile_spi <- precip_to_spi(tsaile_precip)

# Tsaile SPI June

tsaile_spi_june <- tsaile_spi %>% 
  filter(year(date) >= 2004) %>% 
  filter(month(date) == 6) %>% 
  add_water_year() %>% 
  select(waterYear, spi)

```

```{r, echo = FALSE}

# whole year 6 month SPI
plot_spi(tsaile_spi, month = all_months, title = "Tsaile SPI")

# let's take a look at the 6 month June SPI of each year
plot_spi(tsaile_spi, month = c(6), title = "Tsaile June SPI")

```

#### 3 month SPI
```{r, include = FALSE}

# now change the precip data to spi
tsaile_spi_3 <- precip_to_spi(tsaile_precip, timeframe = 3)

```

```{r, echo = FALSE}


# whole year 6 month SPI
plot_spi(tsaile_spi, month = all_months, title = "Tsaile SPI")

# let's take a look at the 6 month June SPI of each year
plot_spi(tsaile_spi, month = c(6), title = "Tsaile June SPI")

```


### Tsaile SPI and Chuska SWE

```{r, echo = FALSE}
### now let's look at Chuska monthly swe anomaly and Tsaile SPI Jan-June ###
plot_swe_spi(tsaile_spi, month = c(6), region_time = "Tsaile June 6 month")

```

- 7/10 of negative swe years followed by negative spi
- 4/6 of positive swe years followed by positive spi 

```{r, echo = FALSE}

# let's look at the correlation between them 
ch_tsaile_spi_june <- tsaile_spi_june %>% 
   merge(ch_wint_anom, by = "waterYear") %>% 
   rename(swe_anom = anomaly_perc)

plot_cor_swe_spi(ch_tsaile_spi_june, title = "Chuska Winter SWE Anomaly and Tsaile Jan-June SPI")

ch_tsaile_correct <- swe_spi_same(ch_tsaile_spi_june, type = "total")
ch_tsaile_positive <- swe_spi_same(ch_tsaile_spi_june, type = "positive")
ch_tsaile_negative <- swe_spi_same(ch_tsaile_spi_june, type = "negative")

```

- The percent of times swe the anomaly for the year and spi had the same sign `r ch_tsaile_correct*100`%

- The percent of times swe anomaly for the year was positive and was followed by a positive spi had the same sign out of all positive swe years `r ch_tsaile_positive*100`%

- The percent of times swe anomaly for the year was negative and was followed by a negative spi had the same sign out of all negative swe years `r ch_tsaile_negative*100`%

### 3 month SPI
```{r, echo=FALSE}
plot_swe_spi(tsaile_spi_3, month = c(6), region_time = "Tsaile June 3 month")
```

